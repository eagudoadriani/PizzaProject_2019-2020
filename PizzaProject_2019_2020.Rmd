---
title: "Effect of herbivory and nutrients on Galapagos' algae"
author: "Esteban Agudo"
date: "8/25/2020"
output:
  word_document: default
  html_document:
    df_print: paged
always_allow_html: yes
---

```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpubr)
library(viridis)
library(hrbrthemes)
library(gridExtra)
library(stats)
library(kableExtra)
library(flextable)
library(reshape2)
library(xlsx)

# Colleen added this one
library(cowplot)

```

# Effect of herbivore exclussion and nutrient addition on algae cover.

##Cold season
Uploading data for the cold season, then preparing data for plotting. 
```{r}
cold_2019<-read.csv(file="AlgaeCover_Cold2019.csv", header=T)

cold_2019<-na.omit(cold_2019)

cold_2019$Week<-as.factor(cold_2019$Week)
cold_2019$Cage.Number<-as.factor(cold_2019$Cage.Number)

#Changing the names and reordering levels of the factor nutrient addition.

levels(cold_2019$N)<-(c("N+"="Nutrient addition", "No N"="Ambient nutrients"))

cold_2019$N<-factor(cold_2019$N, levels(cold_2019$N)[2:1])

levels(cold_2019$N)

#Reordering  the levels of the treatments
cold_2019$Treatment<-factor(cold_2019$Treatment,
      levels(cold_2019$Treatment)[c(1, 2, 4, 3)])

#Changing the name of the levels in treatment
levels(cold_2019$Treatment)<-(c("All present"="Open Cages", "Fish only"="Fish access", "Urchins Only"="Urchin access", "None present"="Full exclusion"))
```

Estimating values and preparing plot. 
```{r, fig.height=5, fig.width=10}
cold_2019_average<-cold_2019 %>%
  select(Cage.Number, Treatment, N, Week, Algae) %>%
group_by(Week,Treatment, N) %>%
summarise(mean=mean(Algae), se=sd(Algae)/sqrt(length(Algae))) %>%
  filter(Treatment!= "Fish access") #Removing fish treatment

# Ploting weekly changes for the cold season 
colour.palette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

Algae_CoverColdSeason<-ggplot(cold_2019_average, aes(x=Week, y=mean, colour=Treatment, group=Treatment)) + 
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.8, position=position_dodge(width=0.4), linetype="dotted", size=.4)+
    geom_line(position=position_dodge(width=0.4)) +
    geom_point(size = 2, position=position_dodge(width=0.4))+ 
  facet_wrap(~N, nrow=1) +theme_bw()+theme(legend.position = "bottom")+ theme(panel.grid.major = element_blank(), panel.grid.minor=element_blank())+
  labs(y="Mean algae cover (%)", x="Sampling week")+
  scale_color_manual(values=colour.palette)
```

### Plotting
```{r, fig.height=5, fig.width=10}
Algae_CoverColdSeason

png("AlgaeCover_ColdSeason.png", width=14, height=10, units="cm", res=300)
print(Algae_CoverColdSeason)
dev.off()
```
Figure 1: Effect of herbivore exclussion and nutrient addition on weekly algae cover during cold season. 

## Warm season
Loading and preparing data of the warm season
```{r}
#Loading and preparing data
warm_2020<-read.csv("AlgaeCover_Warm2020.csv", header=T)
warm_2020$Cage.Number<-as.factor(warm_2020$Cage.Number)
warm_2020$Week<-as.factor(warm_2020$Week)

levels(warm_2020$N)<-(c("N+"="Nutrient addition", "No N"="Ambient nutrients"))

warm_2020$N<-factor(warm_2020$N, levels(warm_2020$N)[2:1])

warm_2020$Treatment<- factor(warm_2020$Treatment, 
              levels(warm_2020$Treatment)[c(1,3,2)])

levels(warm_2020$Treatment)<-(c("All present"="Open Cages",  "Urchins Only"="Urchin access", "None present"="Full exclusion"))
```
### Plotting
```{r, fig.height=5, fig.width=10}
warm_2020_average<-warm_2020 %>%
  select(Cage.Number, Treatment, N, Week, Algae) %>%
group_by(Week,Treatment, N) %>%
summarise(mean=mean(Algae), se=sd(Algae)/sqrt(length(Algae)))

AlgaeCover_HotSeason<-ggplot(warm_2020_average, aes(x=Week, y=mean, colour=Treatment, group=Treatment)) + 
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.8, position=position_dodge(width=0.4), linetype="dotted",size=.4)+
    geom_line(position=position_dodge(width=0.4)) +
    geom_point(size=2, position=position_dodge(width=0.4))+ facet_wrap(~N, nrow=1) +theme_bw()+theme(legend.position = "bottom")+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(y="Mean algae cover (%)", x="Sampling week")+
  scale_color_manual(values=colour.palette)
```


```{r, fig.height=5, fig.width=10}
AlgaeCover_HotSeason

png("AlgaeCover_HotSeason.png", width=14, height=10, units="cm", res=300)
print(AlgaeCover_HotSeason)
dev.off()
```
Figure 2: Effect of herbivore exclussion and nutrient addition on algae cover during warm season. 

# Effect of herbivore's exclussion and nutrient addition on algae weight.  

Data uploading and preparation including changing names and reordering factors.
```{r}
#Loading data
AlgaeWeight_Cold2019<-read.csv(file="AlgaeWeight_Cold2019.csv")
AlgaeWeight_Warm2020<-read.csv(file="AlgaeWeight_Warm2020.csv")

#Reordering and renaming Factor: Nutrient
levels(AlgaeWeight_Cold2019$N)<-c("N+"="Nutrient addition", "No N"="Ambient nutrients")

levels(AlgaeWeight_Warm2020$N)<-c("N+"="Nutrient addition", "No N"="Ambient nutrients")

AlgaeWeight_Cold2019$N<-factor(AlgaeWeight_Cold2019$N, levels(AlgaeWeight_Cold2019$N)[2:1])

AlgaeWeight_Warm2020$N<-factor(AlgaeWeight_Warm2020$N, levels(AlgaeWeight_Warm2020$N)[2:1])

#Reordering and renaming factor Treatment
AlgaeWeight_Cold2019$Treatment<-factor(
  AlgaeWeight_Cold2019$Treatment, 
    levels(AlgaeWeight_Cold2019$Treatment)[c(1,2,4,3)])

AlgaeWeight_Warm2020$Treatment<-factor(
  AlgaeWeight_Warm2020$Treatment, 
  levels(AlgaeWeight_Warm2020$Treatment)[c(1,3,2)])

levels(AlgaeWeight_Cold2019$Treatment)<-(c("All present"="Open Cages", "Fish only"="Fish access", "Urchins Only"="Urchin access", "None present"="Full exclusion"))


levels(AlgaeWeight_Warm2020$Treatment)<-(c("All present"="Open Cages", "Urchins Only"="Urchin access", "None present"="Full exclusion"))

AlgaeWeight_Cold2019<-AlgaeWeight_Cold2019 %>%
  filter(Treatment!="Fish access")%>% #Removing exclussion treatment with access to fish
  filter(Sample.weight.postburn..g.!=0) #Removing sampling units zeros

AlgaeWeight_Warm2020<-AlgaeWeight_Warm2020 %>%
    filter(Sample.weight.postburn..g.!=0) # Removing zeros 
```

```{r}
AlgaeWeight_Cold2019_Average<-AlgaeWeight_Cold2019 %>%
  group_by(Treatment, N) %>%
  summarise(Mean_AlgaeWeight=mean(Sample.weight.postburn..g.), 
            se=sd(Sample.weight.postburn..g.)/sqrt(length(Sample.weight.postburn..g.))) 

AlgaeWeight_Warm2020_Average<-AlgaeWeight_Warm2020 %>%
  group_by(Treatment, N) %>%
  summarise(Mean_AlgaeWeight=mean(Sample.weight.postburn..g.), 
            se=sd(Sample.weight.postburn..g.)/sqrt(length(Sample.weight.postburn..g.)))
```
### Ploting Box plots (using collen code)  for cold season 

```{r}
# Summarizing data for each plot in order

summary.df <- AlgaeWeight_Cold2019 %>% 
  group_by(Treatment, N) %>% # input your grouping variable (seperate by commas if more than one)
  summarize(mean = round(mean(Sample.weight.postburn..g., na.rm = TRUE), 2),
            max = round(max(Sample.weight.postburn..g., na.rm = TRUE), 2),
            min = round(min(Sample.weight.postburn..g., na.rm = TRUE), 2),
            sd = sd(Sample.weight.postburn..g., na.rm = TRUE),
            n = n(),
          se=sd / sqrt(n))%>% 
  mutate(lowerci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upperci = mean + qt(1 - (0.05 / 2), n - 1) * se)

```

```{r}
X <- summary.df$N # item to plot on x-axis
df <- summary.df # dataframe containing your summary stats
colour <- summary.df$Treatment # item to colour data by  
overall.mean <- round(mean(AlgaeWeight_Cold2019$Sample.weight.postburn..g.), 2) # modify this to change location of dashed line
ylab <- "Dry algae weight(gr)" # input y-axis label here (put "" if you want to leave label blank)
xlab <- "" # input x-axis label here (put "" if you want to leave label blank)
title <- "" # overall plot title (put "" if no title)

colour.palette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
# This is just a nicer (colour blind friendly) colour palette that avoids defaults
```

### Plotting: Algae weight during cold season   

```{r}
P1<-ggplot() +
  theme_classic() + # sets plot theme (removes gridlines, etc.)
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.7)) + # adds box around plot area
  #geom_hline(yintercept = overall.mean, colour = "darkgrey", linetype = 2) + # dashed line
  geom_point(data = AlgaeWeight_Cold2019, aes(x =N , y = Sample.weight.postburn..g., colour = Treatment), shape = 1, alpha = 0.4,              position = position_jitterdodge(jitter.width = NULL, jitter.height = 0,dodge.width = 0.85)) +
  geom_errorbar(data = df, aes(x = X, ymin = mean-se, ymax = mean+se, colour = colour), size = 8, width = 0, alpha = 0.6, position = position_dodge(width = 0.85), show.legend = FALSE) + # this plots SE behind the mean, can use also CI with summarize
  geom_point(data = df, aes(x = X, y = mean, colour = colour), shape = "-", size = 20, position = position_dodge(width = 0.85)) + # plots the mean value 
  scale_colour_manual(name = "", values = colour.palette) + # adds the colours for plotting
  ylab(ylab) + # y-axis label
scale_y_continuous(expand=c(0,0), breaks=seq(0, 15, 1), limits = c(0, 15)) + # makes the y-axis display as $
  xlab(xlab) + # x-axis label
   ggtitle(title)+ # whole plot title
  theme(axis.text.x = element_text(size = 9.5),
        axis.title.y = element_text(size = 9.5, hjust = 0.6, vjust = 2.5),
      legend.position = "bottom", 
      legend.text = element_text(size = 10),  
      legend.key.size = unit(0.5, "cm"),
      legend.key.height = unit(0.5, "cm"))+ #Legend theme
     guides(colour = guide_legend(override.aes = list(shape = 15, size=3)))
```
### Plotting effect herbivory and nutrient addition on algae weight during warm season
```{r}
# summarizing

summary.df <- AlgaeWeight_Warm2020 %>% 
  group_by(Treatment, N) %>% # input your grouping variable (seperate by commas if more than one)
  summarize(mean = round(mean(Sample.weight.postburn..g., na.rm = TRUE), 2),
            max = round(max(Sample.weight.postburn..g., na.rm = TRUE), 2),
            min = round(min(Sample.weight.postburn..g., na.rm = TRUE), 2),
            sd = sd(Sample.weight.postburn..g., na.rm = TRUE),
            n = n(),
            se=sd/sqrt(n)) %>% 
  mutate(lowerci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upperci = mean + qt(1 - (0.05 / 2), n - 1) * se)

```
Estimating values for plot
```{r}
X <- summary.df$N # item to plot on x-axis
df <- summary.df # dataframe containing your summary stats
colour <- summary.df$Treatment # item to colour data by  
overall.mean <- round(mean(AlgaeWeight_Warm2020$Sample.weight.postburn..g.), 2) # modify this to change location of dashed line
ylab <- "Dry algae weight(gr)" # input y-axis label here (put "" if you want to leave label blank)
xlab <- "" # input x-axis label here (put "" if you want to leave label blank)
title <- "" # overall plot title (put "" if no title)

colour.palette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
# This is just a nicer (colour blind friendly) colour palette that avoids defaults
```

Let's build the same plot fot the warm season  
```{r}
P2<-ggplot() +
  theme_classic() + # sets plot theme (removes gridlines, etc.)
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.7)) + # adds box around plot area
  #geom_hline(yintercept = overall.mean, colour = "darkgrey", linetype = 2) + # dashed line
  geom_point(data = AlgaeWeight_Warm2020, aes(x =N , y = Sample.weight.postburn..g., colour = Treatment), shape = 1, alpha = 0.4,              position = position_jitterdodge(jitter.width = NULL, jitter.height = 0,dodge.width = 0.85)) +
  geom_errorbar(data = df, aes(x = X, ymin = mean-se, ymax = mean+se, colour = colour), size = 8, width = 0, alpha = 0.6, position = position_dodge(width = 0.85), show.legend = FALSE) + # this plots SE behind the mean-Can change a CI using CI in summarize
  geom_point(data = df, aes(x = X, y = mean, colour = colour), shape = "-", size = 20, position = position_dodge(width = 0.85)) + # plots the mean value 
  scale_colour_manual(name = "", values = colour.palette) + # adds the colours for plotting
  ylab(ylab) + # y-axis label
scale_y_continuous(expand=c(0,0), breaks=seq(0, 15, 1), limits = c(0, 15)) + # makes the y-axis display as $
  xlab(xlab) + # x-axis label
   ggtitle(title)+ #legend theme
  theme(axis.text.x = element_text(size = 9.5),
        axis.title.y = element_text(size = 9.5, hjust = 0.6, vjust = 2.5),
      legend.position = "bottom", 
      legend.text = element_text(size =10), 
      legend.key.size = unit(0.5, "cm"),  
      legend.key.height = unit(0.5, "cm"))+
    guides(colour = guide_legend(override.aes = list(shape = 15, size=3)))#Legend them
```

Comparation between the effect of herbivore exclussion and nutrient addition across cold season and warm season. 
```{r}
Algae_weight<-ggarrange(P1, P2, nrow=1, common.legend = TRUE, labels = c("Cold Season", "Warm Season"),            legend="bottom")

Algae_weight
png("AlgaeWeights_se.png", width=15, height=10, units="cm", res=300)
print(Algae_weight)
dev.off()
```

## Analysis of effect between herbivore exclussion and nutriend addition on algae weight

Let's start by checking data distribution:

```{r}
hist(AlgaeWeight_Cold2019$Sample.weight.postburn..g.)
hist(AlgaeWeight_Warm2020$Sample.weight.postburn..g.)

#It is slightly skewed so a sqrt transformation can do the job
hist(log(AlgaeWeight_Cold2019$Sample.weight.postburn..g.))
hist(sqrt(AlgaeWeight_Cold2019$Sample.weight.postburn..g.))

qqnorm(sqrt(AlgaeWeight_Cold2019$Sample.weight.postburn..g.))
qqline(sqrt(AlgaeWeight_Cold2019$Sample.weight.postburn..g.))

qqnorm(log(AlgaeWeight_Cold2019$Sample.weight.postburn..g.+0.001))
qqline(log(AlgaeWeight_Cold2019$Sample.weight.postburn..g.+0.001))

shapiro.test(AlgaeWeight_Cold2019$Sample.weight.postburn..g.)
shapiro.test(sqrt(AlgaeWeight_Cold2019$Sample.weight.postburn..g.))
n#still not normal
#It is severe skewed so we can do a log10 transformation
hist(log10(AlgaeWeight_Warm2020$Sample.weight.postburn..g.))
shapiro.test(AlgaeWeight_Warm2020$Sample.weight.postburn..g)
shapiro.test(sqrt(AlgaeWeight_Warm2020$Sample.weight.postburn..g))
```
Even after transformation data does not seems to resemble normality so we should not use an Anova or any other parametric test. 

### Determine effect of herbivory and nutriend addition using a GLM 
```{r}
#Let's try with a  glm using a gamma distribution. We add 0.0001 as this model cannot work with 0

cold_season_model_gamma<-glm((Sample.weight.postburn..g.+0.01)~Treatment*N, family = Gamma(link="log"), data=AlgaeWeight_Cold2019)
summary(cold_season_model_gamma)

# Let's build a similar model without the interaction
cold_season_model_gamma_NI<-glm((Sample.weight.postburn..g.+0.01)~Treatment+N, family = Gamma(link="log"), data=AlgaeWeight_Cold2019)
summary(cold_season_model_gamma_NI)
#Comparing models with and without interaction
anova(cold_season_model_gamma, cold_season_model_gamma_NI, test='Chisq')
anova(cold_season_model_gamma, test='Chisq') 

#Building a similar model for the warm season
warm_season_model_gamma<-glm((Sample.weight.postburn..g.+0.01)~Treatment+N+Treatment*N, family = Gamma(link="log"), data=AlgaeWeight_Warm2020)
summary(warm_season_model_gamma)

```
### Putting results from gamma model in a table
```{r}
#Let's build the table for the model with the gamma distribution
summary(cold_season_model_gamma)

Estimate<-coef(summary(cold_season_model_gamma))[,1]
Std.Error<-coef(summary(cold_season_model_gamma))[,2]
t.value<-coef(summary(cold_season_model_gamma))[,3]
P.value<-coef(summary(cold_season_model_gamma))[,4]
Treatment<-c("(Intercept)", "Urchin acces", "Full exclusion", "Nutrient addition", "Urchin access x Nutrient addition", "Full exclusion x Nutrient addition")

cold_gamma_table<-data.frame(Treatment, Estimate, Std.Error, t.value, P.value)

cold_gamma_table$Signif.<-ifelse(cold_gamma_table$P.value<0.05, "*", "") 
#cold_gamma_table$Signif.<-ifelse(cold_gamma_table$P.value<0.01 & cold_gamma_table$P.value>0.001, "**", "") 
#cold_gamma_table$Signif.<-ifelse(cold_gamma_table$P.value<0.001, "***", "") 

cold_gamma_table<-cold_gamma_table %>% 
  mutate_if(is.numeric, round, digits=3) 

cold_gamma_table$P.value[cold_gamma_table$P.value<=0.05]<-">0.05"
#cold_gamma_table$P.value[cold_gamma_table$P.value<=0.01 & cold_gamma_table$P.value > 0.001 ]<-">0.01"
#cold_gamma_table$P.value[cold_gamma_table$P.value<=0.001]<-">0.001"

cold_gamma_table<- flextable(cold_gamma_table)
cold_gamma_table<-autofit(cold_gamma_table)
cold_gamma_table<-font(cold_gamma_table, fontname = "Times", part = "header")
cold_gamma_table<-font(cold_gamma_table, fontname = "Times")
cold_gamma_table <- add_header_lines(cold_gamma_table, values = "Cold season")
save_as_image(cold_gamma_table, path = "cold_gamma_table.png")
cold_gamma_table

#Let's do the same for the warm season 

summary(warm_season_model_gamma)

Estimate<-coef(summary(warm_season_model_gamma))[,1]
Std.Error<-coef(summary(warm_season_model_gamma))[,2]
t.value<-coef(summary(warm_season_model_gamma))[,3]
P.value<-coef(summary(warm_season_model_gamma))[,4]
Treatment<-c("(Intercept)", "Urchin acces", "Full exclusion", "Nutrient addition", "Urchin access x Nutrient addition", "Full exclusion x Nutrient addition")

warm_gamma_table<-data.frame(Treatment, Estimate, Std.Error, t.value, P.value)

warm_gamma_table$Signif.<-ifelse(warm_gamma_table$P.value<0.05, "*", "") 

warm_gamma_table<-warm_gamma_table %>% 
  mutate_if(is.numeric, round, digits=3) 

warm_gamma_table$P.value[warm_gamma_table$P.value<=0.05]<-">0.05"
#warm_anova_table$P.value[warm_anova_table$P.value<=0.01]<-">0.01"

warm_gamma_table<- flextable(warm_gamma_table)
warm_gamma_table<-autofit(warm_gamma_table)
warm_gamma_table<-font(warm_gamma_table, fontname = "Times", part = "header")
warm_gamma_table<-font(warm_gamma_table, fontname = "Times")
warm_gamma_table <- add_header_lines(warm_gamma_table, values = "Warm season")
save_as_image(warm_gamma_table, path = "warm_gamma_table.png")
warm_gamma_table
```

## Colleen's suggested bootstrapping method:

```{r bootstrap setup}

### Setup the bootstrap function and number of iterations

# This is a bootstrap function that will sample WITH replacement (explained step by step within the function)
bootFUN <- function(model, newdata) {
  nr <- nrow(model$data) # count number of rows in the model (# of observations)
  data <- model$data # pull data from model
  data <- data[sample(1:nr, size = nr, replace = TRUE), ] # random sample of numbers from 1 - nr (# of rows) to select data from
  update <- update(model, data = data) # rerun the model using the 'new' dataset from the random smapling above
  predict(update, newdata = newdata, type = "response") # predicts response variable with model and updated data 
}

bootnum <- 1500 # this is the number of bootstrap replicates. I set it to 1500 here but we should select a number between 999 and 9999

```

### Warm Season
```{r warm season bootstraping}

## Warm season GLM (I removed the +0.01 since you do not have any 0s here)
warm_glm <- glm(Sample.weight.postburn..g. ~ Treatment * N, family = Gamma(link = "log"), data = AlgaeWeight_Warm2020)

## Run parametric bootstrapping:
newdata <- data.frame(Treatment = AlgaeWeight_Warm2020$Treatment, N = AlgaeWeight_Warm2020$N) # creates dataframe of predictor variables (here, Treatment and N)
boot <- replicate(bootnum, bootFUN(model = warm_glm, newdata = newdata)) # run the bootFUN the number (bootnum) of times specified and save as matrix

# Calculate the mean, 95% lowerCI, and 95% upperCI from the boot matrix and add it to dataframe (but as a new name)
AlgaeWeight_Warm2020_boot <- cbind(AlgaeWeight_Warm2020, as.data.frame(t(apply(boot, 1, function(x) c(mean(x), quantile(x, c(0.025, 0.975)))))))
colnames(AlgaeWeight_Warm2020_boot)[12:14] <- c("mean", "lowerci", "upperci") # rename mean/CI columns

```

```{r warm season boot plot}

### Plot the observational values and bootstrapped mean/CI
warm_boot_plot <- ggplot() +
  theme_bw() + # sets plot theme (removes gridlines, etc.)
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), strip.text.x = element_blank(), panel.background=element_blank(), axis.line=element_line(color="black"), legend.key=element_blank(), strip.background = element_blank(), legend.position="none", panel.border = element_rect(colour = "black", size= 0.8))+
  geom_point(data = AlgaeWeight_Warm2020_boot, aes(x = N , y = Sample.weight.postburn..g., colour = Treatment), shape = 1, alpha = 0.4, position = position_jitterdodge(jitter.width = NULL, jitter.height = 0,dodge.width = 0.85)) +
  geom_linerange(data = AlgaeWeight_Warm2020_boot, aes(x = N, ymin = lowerci, ymax = upperci, colour = Treatment), alpha = 0.1, size = 8, position = position_dodge(width = 0.85)) +
  geom_point(data = AlgaeWeight_Warm2020_boot, aes(x = N, y = mean, colour = Treatment), shape = "-", size = 20, position = position_dodge(width = 0.85)) + # plots the mean value 
  scale_colour_manual(name = "", values = colour.palette) + # adds the colours for plotting
  ylab("Dry algae weight (g)") + # y-axis label
  xlab("") +
  ggtitle("Warm Season") +
  scale_y_continuous(expand=c(0,0), breaks=seq(0, 15, 1), limits = c(0, 15)) + # makes the y-axis display as $
  theme(axis.text.x = element_text(size = 9.5), axis.title.y = element_text(size = 9.5, hjust = 0.6, vjust = 2.5), legend.position = "bottom", legend.text = element_text(size = 10), legend.key.size = unit(0.5, "cm"), legend.key.height = unit(0.5, "cm")) + #Legend theme
  guides(colour = guide_legend(override.aes = list(shape = 15, size=3)))

```


### Cold Season
```{r cold season bootstraping}

## Cold season GLM (I removed the +0.01 since you do not have any 0s here)
cold_glm <- glm(Sample.weight.postburn..g. ~ Treatment * N, family = Gamma(link = "log"), data = AlgaeWeight_Cold2019)

## Run parametric bootstrapping:
newdata <- data.frame(Treatment = AlgaeWeight_Cold2019$Treatment, N = AlgaeWeight_Cold2019$N) # creates dataframe of predictor variables (here, Treatment and N)
boot <- replicate(bootnum, bootFUN(model = cold_glm, newdata = newdata)) # run the bootFUN the number (bootnum) of times specified and save as matrix

# Calculate the mean, 95% lowerCI, and 95% upperCI from the boot matrix and add it to dataframe (but as a new name)
AlgaeWeight_Cold2019_boot <- cbind(AlgaeWeight_Cold2019, as.data.frame(t(apply(boot, 1, function(x) c(mean(x), quantile(x, c(0.025, 0.975)))))))
colnames(AlgaeWeight_Cold2019_boot)[13:15] <- c("mean", "lowerci", "upperci") # rename mean/CI columns

```

```{r cold season boot plot}

### Plot the observational values and bootstrapped mean/CI
cold_boot_plot <- ggplot() +
  theme_bw() + # sets plot theme (removes gridlines, etc.)
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), strip.text.x = element_blank(), panel.background=element_blank(), axis.line=element_line(color="black"), legend.key=element_blank(), strip.background = element_blank(), legend.position="none", panel.border = element_rect(colour = "black", size= 0.8))+
  geom_point(data = AlgaeWeight_Cold2019_boot, aes(x = N , y = Sample.weight.postburn..g., colour = Treatment), shape = 1, alpha = 0.4, position = position_jitterdodge(jitter.width = NULL, jitter.height = 0,dodge.width = 0.85)) +
  geom_linerange(data = AlgaeWeight_Cold2019_boot, aes(x = N, ymin = lowerci, ymax = upperci, colour = Treatment), alpha = 0.1, size = 8, position = position_dodge(width = 0.85)) +
  geom_point(data = AlgaeWeight_Cold2019_boot, aes(x = N, y = mean, colour = Treatment), shape = "-", size = 20, position = position_dodge(width = 0.85)) + # plots the mean value 
  scale_colour_manual(name = "", values = colour.palette) + # adds the colours for plotting
  ylab("Dry algae weight (g)") + # y-axis label
  xlab("") +
  ggtitle("Cool Season") +
  scale_y_continuous(expand=c(0,0), breaks=seq(0, 15, 1), limits = c(0, 15)) + # makes the y-axis display as $
  theme(axis.text.x = element_text(size = 9.5), axis.title.y = element_text(size = 9.5, hjust = 0.6, vjust = 2.5), legend.position = "bottom", legend.text = element_text(size = 10), legend.key.size = unit(0.5, "cm"), legend.key.height = unit(0.5, "cm")) + #Legend theme
  guides(colour = guide_legend(override.aes = list(shape = 15, size=3)))

```


### Cold and warm Bootstrap CI plot

```{r combined CI plot}

Plot_bootstrapCI<-plot_grid(cold_boot_plot, warm_boot_plot, labels = c("C", "D"))
Plot_bootstrapCI

AlgaeWeight_bootCI<-ggarrange(cold_boot_plot, warm_boot_plot, nrow=1, common.legend = TRUE, labels = c("C", "D "),legend="bottom")

png("AlgaeWeight_bootCI.png", width=15, height=10, units="cm", res=300)
print(AlgaeWeight_bootCI)
dev.off()
```

## Tables with boot mean and CI
```{r}
mean_AlgaeWeight_Cold2019_boot<-AlgaeWeight_Cold2019_boot%>%
  group_by(Treatment, N)%>%
  summarise(mean_weight=mean(Sample.weight.postburn..g.), mean_BS=mean(mean), lowerc=mean(lowerci), upperci=mean(upperci))

mean_AlgaeWeight_Cold2019_boot<-as.data.frame(mean_AlgaeWeight_Cold2019_boot)

mean_AlgaeWeight_Warm2020_boot<-AlgaeWeight_Warm2020_boot%>%
  group_by(Treatment, N)%>%
  summarise(mean_weight=mean(Sample.weight.postburn..g.), mean_BS=mean(mean), lowerc=mean(lowerci), upperci=mean(upperci))

mean_AlgaeWeight_Warm2020_boot<-as.data.frame(mean_AlgaeWeight_Warm2020_boot)

write.xlsx(mean_AlgaeWeight_Cold2019_boot, file="Tables.xlsx", sheetName = "Cold_WeightBoot",  col.names = TRUE, row.names = TRUE, append = FALSE)

write.xlsx(mean_AlgaeWeight_Warm2020_boot, file="Tables.xlsx", sheetName = "Warm_WeightBoot",  col.names = TRUE, row.names = TRUE, append = TRUE)
```

